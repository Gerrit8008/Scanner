<!-- SSL/TLS Certificate section -->
        {% if scan.ssl_certificate and 'error' not in scan.ssl_certificate %}
        <div class="card">
            <div class="card-header">
                Web Security
            </div>
            <div class="card-body">
                <!-- SSL/TLS Certificate Results -->
                <h3 class="section-title">SSL/TLS Certificate</h3>
                
                <table class="table">
                    <tr>
                        <th>Issuer</th>
                        <td>{{ scan.ssl_certificate.issuer }}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>
                            <span class="severity {% if scan.ssl_certificate.status == 'Valid' %}low{% else %}high{% endif %}">{{ scan.ssl_certificate.status|upper }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th>Valid Until</th>
                        <td>{{ scan.ssl_certificate.valid_until }}</td>
                    </tr>
                    <tr>
                        <th>Days Remaining</th>
                        <td>{{ scan.ssl_certificate.days_remaining }}</td>
                    </tr>
                    <tr>
                        <th>Protocol</th>
                        <td>{{ scan.ssl_certificate.protocol_version }}</td>
                    </tr>
                    <tr>
                        <th>Weak Protocol</th>
                        <td>
                            <span class="severity {% if scan.ssl_certificate.weak_protocol %}high{% else %}low{% endif %}">{{ 'Yes' if scan.ssl_certificate.weak_protocol else 'No' }}</span>
                        </td>
                    </tr>
                </table>
                
                {% if scan.ssl_certificate.is_expired or scan.ssl_certificate.expiring_soon or scan.ssl_certificate.weak_protocol %}
                <div class="findings">
                    {% if scan.ssl_certificate.is_expired %}
                    <div class="finding high">
                        <div class="title">Expired SSL Certificate <span class="severity high">High</span></div>
                        <p>Your SSL certificate has expired and needs to be renewed immediately.</p>
                    </div>
                    {% elif scan.ssl_certificate.expiring_soon %}
                    <div class="finding medium">
                        <div class="title">SSL Certificate Expiring Soon <span class="severity medium">Medium</span></div>
                        <p>Your SSL certificate will expire in {{ scan.ssl_certificate.days_remaining }} days.</p>
                    </div>
                    {% endif %}
                    
                    {% if scan.ssl_certificate.weak_protocol %}
                    <div class="finding high">
                        <div class="title">Weak SSL/TLS Protocol <span class="severity high">High</span></div>
                        <p>Your server is using {{ scan.ssl_certificate.protocol_version }}, which is considered insecure. Upgrade to TLS 1.2 or higher.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Security Headers Results -->
                {% if scan.security_headers and 'error' not in scan.security_headers %}
                <h3 class="section-title">HTTP Security Headers</h3>
                
                <div class="summary-card">
                    <h3>Security Headers Score</h3>
                    <div class="summary-value {% if scan.security_headers.score >= 80 %}score-low{% elif scan.security_headers.score >= 60 %}score-medium{% else %}score-high{% endif %}">{{ scan.security_headers.score }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ scan.security_headers.score|default(0) }}%; background-color: {% if scan.security_headers.score is defined and scan.security_headers.score >= 80 %}#198754{% elif scan.security_headers.score is defined and scan.security_headers.score >= 60 %}#fd7e14{% else %}#dc3545{% endif %};"></div>
                    </div>
                </div>
                
                {% if scan.security_headers.headers %}
                <h4>Security Headers</h4>
                <table class="table">
                    <tr>
                        <th>Header</th>
                        <th>Status</th>
                    </tr>
                    {% for header, found in scan.security_headers.headers.items() %}
                    <tr>
                        <td>{{ header }}</td>
                        <td>{% if found %}‚úÖ Present{% else %}‚ùå Missing{% endif %}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
                {% endif %}
                
                <!-- Web Framework Detection -->
                {% if scan.frameworks and scan.frameworks.count > 0 %}
                <h3 class="section-title">Web Frameworks</h3>
                <p>We detected the following web frameworks on your site:</p>
                <ul>
                    {% for framework in scan.frameworks.frameworks %}
                    <li>{{ framework }}</li>
                    {% endfor %}
                </ul>
                <div class="alert alert-info">
                    <strong>Note:</strong> Some frameworks may expose version information that can help attackers target known vulnerabilities. Make sure all frameworks are up to date.
                </div>
                {% endif %}

                <!-- Cookie Security Analysis -->
                {% if scan.cookies and 'error' not in scan.cookies %}
                <h3 class="section-title">Cookie Security</h3>
                <div class="summary-card">
                    <h3>Cookie Security Score</h3>
                    <div class="summary-value {% if scan.cookies.score >= 80 %}score-low{% elif scan.cookies.score >= 60 %}score-medium{% else %}score-high{% endif %}">{{ scan.cookies.score }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ scan.cookies.score|default(0) }}%; background-color: {% if scan.cookies.score is defined and scan.cookies.score >= 80 %}#198754{% elif scan.cookies.score is defined and scan.cookies.score >= 60 %}#fd7e14{% else %}#dc3545{% endif %};"></div>
                    </div>
                </div>
                
                <table class="table">
                    <tr>
                        <th>Total Cookies</th>
                        <td>{{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>Secure Cookies</th>
                        <td>{{ scan.cookies.secure_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>HttpOnly Cookies</th>
                        <td>{{ scan.cookies.httponly_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>SameSite Cookies</th>
                        <td>{{ scan.cookies.samesite_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                </table>
                
                {% if scan.cookies.severity in ['High', 'Medium'] %}
                <div class="finding {% if scan.cookies.severity == 'High' %}high{% else %}medium{% endif %}">
                    <div class="title">Cookie Security Issues <span class="severity {% if scan.cookies.severity == 'High' %}high{% else %}medium{% endif %}">{{ scan.cookies.severity }}</span></div>
                    <p>Your website cookies are not properly secured. This could allow attackers to steal session information or perform cross-site request forgery attacks.</p>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- CMS Detection Results -->
                {% if scan.cms and scan.cms.cms_detected %}
                <h3 class="section-title">Content Management System (CMS)</h3>
                
                <div class="summary-card">
                    <h3>{{ scan.cms.cms_name }}</h3>
                    <p>Version: {{ scan.cms.version }}</p>
                </div>
                
                {% if scan.cms.potential_vulnerabilities %}
                <h4>Potential Vulnerabilities</h4>
                <div class="findings">
                    {% for vuln in scan.cms.potential_vulnerabilities %}
                    <div class="finding high">
                        <div class="title">CMS Vulnerability <span class="severity high">High</span></div>
                        <p>{{ vuln }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}

                <!-- Security Headers Results -->
                {% if scan.security_headers and 'error' not in scan.security_headers %}
                <h3 class="section-title">HTTP Security Headers</h3>
                
                <div class="summary-card">
                    <h3>Security Headers Score</h3>
                    <div class="summary-value {% if scan.security_headers.score >= 80 %}score-low{% elif scan.security_headers.score >= 60 %}score-medium{% else %}score-high{% endif %}">{{ scan.security_headers.score }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ scan.security_headers.score|default(0) }}%; background-color: {% if scan.security_headers.score is defined and scan.security_headers.score >= 80 %}#198754{% elif scan.security_headers.score is defined and scan.security_headers.score >= 60 %}#fd7e14{% else %}#dc3545{% endif %};"></div>
                    </div>
                </div>
                
                {% if scan.security_headers.headers %}
                <h4>Security Headers</h4>
                <table class="table">
                    <tr>
                        <th>Header</th>
                        <th>Status</th>
                    </tr>
                    {% for header, found in scan.security_headers.headers.items() %}
                    <tr>
                        <td>{{ header }}</td>
                        <td>{% if found %}‚úÖ Present{% else %}‚ùå Missing{% endif %}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
                {% endif %}
                
                <!-- Web Framework Detection -->
                {% if scan.frameworks and scan.frameworks.count > 0 %}
                <h3 class="section-title">Web Frameworks</h3>
                <p>We detected the following web frameworks on your site:</p>
                <ul>
                    {% for framework in scan.frameworks.frameworks %}
                    <li>{{ framework }}</li>
                    {% endfor %}
                </ul>
                <div class="alert alert-info">
                    <strong>Note:</strong> Some frameworks may expose version information that can help attackers target known vulnerabilities. Make sure all frameworks are up to date.
                </div>
                {% endif %}

                <!-- Cookie Security Analysis -->
                {% if scan.cookies and 'error' not in scan.cookies %}
                <h3 class="section-title">Cookie Security</h3>
                <div class="summary-card">
                    <h3>Cookie Security Score</h3>
                    <div class="summary-value {% if scan.cookies.score >= 80 %}score-low{% elif scan.cookies.score >= 60 %}score-medium{% else %}score-high{% endif %}">{{ scan.cookies.score }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ scan.cookies.score|default(0) }}%; background-color: {% if scan.cookies.score is defined and scan.cookies.score >= 80 %}#198754{% elif scan.cookies.score is defined and scan.cookies.score >= 60 %}#fd7e14{% else %}#dc3545{% endif %};"></div>
                    </div>
                </div>
                
                <table class="table">
                    <tr>
                        <th>Total Cookies</th>
                        <td>{{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>Secure Cookies</th>
                        <td>{{ scan.cookies.secure_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>HttpOnly Cookies</th>
                        <td>{{ scan.cookies.httponly_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                    <tr>
                        <th>SameSite Cookies</th>
                        <td>{{ scan.cookies.samesite_cookies }} / {{ scan.cookies.total_cookies }}</td>
                    </tr>
                </table>
                
                {% if scan.cookies.severity in ['High', 'Medium'] %}
                <div class="finding {% if scan.cookies.severity == 'High' %}high{% else %}medium{% endif %}">
                    <div class="title">Cookie Security Issues <span class="severity {% if scan.cookies.severity == 'High' %}high{% else %}medium{% endif %}">{{ scan.cookies.severity }}</span></div>
                    <p>Your website cookies are not properly secured. This could allow attackers to steal session information or perform cross-site request forgery attacks.</p>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- CMS Detection Results -->
                {% if scan.cms and scan.cms.cms_detected %}
                <h3 class="section-title">Content Management System (CMS)</h3>
                
                <div class="summary-card">
                    <h3>{{ scan.cms.cms_name }}</h3>
                    <p>Version: {{ scan.cms.version }}</p>
                </div>
                
                {% if scan.cms.potential_vulnerabilities %}
                <h4>Potential Vulnerabilities</h4>
                <div class="findings">
                    {% for vuln in scan.cms.potential_vulnerabilities %}
                    <div class="finding high">
                        <div class="title">CMS Vulnerability <span class="severity high">High</span></div>
                        <p>{{ vuln }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- DNS Configuration -->
        {% if scan.is_domain is defined and scan.is_domain and 'email_security' in scan %}
        <div class="card">
            <div class="card-header">
                DNS Configuration
            </div>
            <div class="card-body">
                <p>Domain: {{ scan.email_security.domain }}</p>
                
                <table class="table">
                    <tr>
                        <th>Record Type</th>
                        <th>Status</th>
                    </tr>
                    <tr>
                        <td>SPF</td>
                        <td>{{ scan.email_security.spf.status }}</td>
                    </tr>
                    <tr>
                        <td>DMARC</td>
                        <td>{{ scan.email_security.dmarc.status }}</td>
                    </tr>
                    <tr>
                        <td>DKIM</td>
                        <td>{{ scan.email_security.dkim.status }}</td>
                    </tr>
                </table>
                
                <div class="alert alert-info">
                    <strong>Note:</strong> Proper DNS configuration is essential for email deliverability and security. SPF, DKIM, and DMARC help prevent email spoofing and phishing attacks.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Detailed Port Analysis -->
        {% if scan.network and scan.network.open_ports and scan.network.open_ports.list|length > 0 %}
        <div class="card">
            <div class="card-header">
                Detailed Port Analysis
            </div>
            <div class="card-body">
                <h3>Port Risk Assessment</h3>
                <table class="table">
                    <tr>
                        <th>Port</th>
                        <th>Service</th>
                        <th>Risk Level</th>
                    </tr>
                    {% for port in scan.network.open_ports.list %}
                        <tr>
                            <td>{{ port }}</td>
                            <td>
                                {% if port == 21 %}
                                    FTP - File Transfer Protocol
                                {% elif port == 22 %}
                                    SSH - Secure Shell
                                {% elif port == 23 %}
                                    Telnet - Insecure remote access
                                {% elif port == 25 %}
                                    SMTP - Email transmission
                                {% elif port == 80 %}
                                    HTTP - Web traffic (unencrypted)
                                {% elif port == 443 %}
                                    HTTPS - Secure web traffic
                                {% elif port == 3389 %}
                                    RDP - Remote Desktop Protocol
                                {% elif port == 5900 %}
                                    VNC - Virtual Network Computing
                                {% elif port == 8080 %}
                                    HTTP Alternate - Often used for proxies
                                {% elif port == 3306 %}
                                    MySQL Database
                                {% else %}
                                    Unknown service
                                {% endif %}
                            </td>
                            <td>
                                {% if port in [21, 23, 3389, 5900, 445, 139] %}
                                    <span class="severity high">High Risk</span>
                                {% elif port in [80, 8080, 110, 143, 25] %}
                                    <span class="severity medium">Medium Risk</span>
                                {% else %}
                                    <span class="severity low">Low Risk</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </table>
                
                <div class="alert alert-warning">
                    <strong>Security Recommendation:</strong> Close any ports that are not actively needed for your operations, especially high-risk ports like Telnet (23), FTP (21), RDP (3389), and VNC (5900).
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Actions Buttons -->
        <div class="card">
            <div class="card-header">
                Next Steps
            </div>
            <div class="card-body">
                <p>
                    <strong>Need help addressing these vulnerabilities?</strong> Our security experts can help you implement the recommendations from this report.
                </p>
                
                <a href="/scan" class="btn btn-primary me-2">Run Another Scan</a>
                <a href="#" class="btn contact-us" id="emailReportBtn">Email This Report</a>
                <a href="#" class="btn contact-us ms-2" id="printReportBtn">Print Report</a>
                
                <div class="mt-4">
                    <h4>Our Services Include:</h4>
                    <ul>
                        <li>Vulnerability Remediation</li>
                        <li>Network Security Configuration</li>
                        <li>Email Security Setup</li>
                        <li>System Security Updates</li>
                        <li>Web Application Hardening</li>
                        <li>Security Awareness Training</li>
                        <li>Ongoing Security Monitoring</li>
                    </ul>
                    <p>
                        <strong>Contact us today to discuss how we can help secure your systems.</strong>
                    </p>
                    <div class="text-center mt-3">
                        <a href="tel:+14704810400" class="btn contact-us">
                            Call: 470-481-0400
                        </a>
                        <a href="mailto:sales@cengatech.com" class="btn contact-us ms-2">
                            Email: sales@cengatech.com
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Technical Details Section -->
        <div class="card mt-5">
            <div class="card-header d-flex justify-content-between">
                <span>Technical Details</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#debugData">Show/Hide</button>
            </div>
            <div class="collapse" id="debugData">
                <div class="card-body">
                    <pre>{{ scan|tojson(indent=2) }}</pre>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2025 Central Georgia Technology. All rights reserved.</p>
    </div>
    
    <button class="print-button" id="floatingPrintBtn" title="Print Report">
        <i class="bi bi-printer"></i>üìÑ
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Print functionality
        document.getElementById('printReportBtn').addEventListener('click', function(e) {
            e.preventDefault();
            window.print();
        });
        
        document.getElementById('floatingPrintBtn').addEventListener('click', function() {
            window.print();
        });
        
        // Email report functionality - UPDATED
        document.getElementById('emailReportBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const email = prompt("Enter your email address to receive this report:");
            if (email && email.includes('@')) {
                // Get the scan_id from the page data
                const scanId = document.getElementById('scan-id').value;
                
                // Show loading state
                const originalText = this.textContent;
                this.textContent = "Sending...";
                this.disabled = true;
                
                // Send the API request
                fetch('/api/email_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'scan_id': scanId,
                        'email': email
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert("Report has been sent to " + email);
                    } else {
                        alert("Error: " + (data.message || "Failed to send email"));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Failed to send the report. Please try again later.");
                })
                .finally(() => {
                    // Reset button state
                    this.textContent = originalText;
                    this.disabled = false;
                });
            } else if (email) {
                alert("Please enter a valid email address.");
            }
        });
    });
    </script>
</body>
</html>
